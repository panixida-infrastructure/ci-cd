on:
  workflow_call:
    inputs:
      coverage_assembly_filters:
        type: string
      coverage_threshold:
        type: string

    secrets:
      registry-user:
        required: true
      registry-token:
        required: true

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      REPORT_DIRECTORY: tests-report
      COVERAGE_DIRECTORY: tests-report/coverage
      COVERAGE_ASSEMBLY_FILTERS: ${{ inputs.coverage_assembly_filters }}
      COVERAGE_THRESHOLD: ${{ inputs.coverage_threshold }}

    steps:
      - uses: actions/checkout@v4

      - name: Create nuget.config
        if: ${{ vars.NUGET_CONFIG != '' }}
        env:
          NUGET_CONFIG: ${{ vars.NUGET_CONFIG }}          
          NUGET_PROVIDER: ${{ vars.NUGET_PROVIDER }}
          REGISTRY_USER: ${{ secrets.registry-user }}
          REGISTRY_TOKEN: ${{ secrets.registry-token }}
        run: |
          echo "$NUGET_CONFIG" | envsubst > ${{ vars.PROJECT_FOLDER }}/nuget.config      

      - name: dotnet restore
        working-directory: ${{ vars.PROJECT_FOLDER }}
        run: |
          dotnet restore

      - name: Run tests with coverage
        working-directory: ${{ vars.PROJECT_FOLDER }}
        run: |
          set -eo pipefail
          mkdir -p "$REPORT_DIRECTORY"

          set +e
          dotnet test \
            --results-directory "$REPORT_DIRECTORY" \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=test_results.trx"
          TEST_EXIT=$?
          set -e

          echo "Test exit code saved: $TEST_EXIT"
          echo "TEST_EXIT=$TEST_EXIT" >> $GITHUB_ENV

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Tests
          path: ${{ env.REPORT_DIRECTORY }}/**/*.trx
          reporter: dotnet-trx
          fail-on-error: "false"          

      - name: Install reportgenerator
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.4.16
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Generate coverage summary (no HTML)
        run: |
          reportgenerator \
            -reports:"**/coverage.cobertura.xml" \
            -targetdir:"$COVERAGE_DIRECTORY" \
            -reporttypes:"TextSummary;MarkdownSummary" \
            -assemblyfilters:"$COVERAGE_ASSEMBLY_FILTERS"

      - name: Add coverage to job summary
        if: always()
        run: |
          echo "## Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f "$COVERAGE_DIRECTORY/Summary.md" ]; then
            cat "$COVERAGE_DIRECTORY/Summary.md" >> $GITHUB_STEP_SUMMARY
          else
            cat "$COVERAGE_DIRECTORY/Summary.txt" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Assert coverage threshold
        run: |
          LINE_COVERAGE=$(grep -Po 'Line coverage[:\s]+\K[\d.]+' "$COVERAGE_DIRECTORY/Summary.txt" | head -1 || echo 0)
          echo "ðŸ“Š Line coverage: ${LINE_COVERAGE}% (threshold: ${COVERAGE_THRESHOLD}%)"
          awk -v c="$LINE_COVERAGE" -v t="$COVERAGE_THRESHOLD" 'BEGIN{exit (c+0<t+0)}' \
            || { echo "âŒ Coverage ${LINE_COVERAGE}% Ð½Ð¸Ð¶Ðµ Ð¿Ð¾Ñ€Ð¾Ð³Ð° ${COVERAGE_THRESHOLD}%"; exit 1; }

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tests-and-coverage-report
          retention-days: 1
          path: |
            tests-report/coverage/
            tests-report/**/*.trx
