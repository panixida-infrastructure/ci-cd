on:
  workflow_call:
    secrets:
      registry-user:
        required: true
      registry-token:
        required: true

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      REPORT_DIRECTORY: tests-report
      COVERAGE_DIRECTORY: tests-report/coverage

    steps:
      - uses: actions/checkout@v4

      - name: Create nuget.config
        if: ${{ vars.NUGET_CONFIG != '' }}
        env:
          NUGET_CONFIG: ${{ vars.NUGET_CONFIG }}          
          NUGET_PROVIDER: ${{ vars.NUGET_PROVIDER }}
          REGISTRY_USER: ${{ secrets.registry-user }}
          REGISTRY_TOKEN: ${{ secrets.registry-token }}
        run: |
          echo "$NUGET_CONFIG" | envsubst > ${{ vars.PROJECT_FOLDER }}/nuget.config       

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-

      - name: dotnet restore
        working-directory: ${{ vars.PROJECT_FOLDER }}
        run: |
          dotnet restore

      - name: Run tests with coverage
        working-directory: ${{ vars.PROJECT_FOLDER }}
        run: |
          set -eo pipefail
          mkdir -p "$REPORT_DIRECTORY"

          set +e
          dotnet test \
            --no-restore \
            --results-directory "$REPORT_DIRECTORY" \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=test_results.trx"
          TEST_EXIT=$?
          set -e

          if [ "$TEST_EXIT" -ne 0 ]; then
            echo "Tests failed with exit code $TEST_EXIT"
            exit $TEST_EXIT
          fi

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Tests
          path: ${{ env.REPORT_DIRECTORY }}/**/*.trx
          reporter: dotnet-trx
          fail-on-error: "false"          

      - name: Install reportgenerator
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.4.16
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Generate coverage summary
        run: |
          reportgenerator \
            -reports:"**/coverage.cobertura.xml" \
            -targetdir:"$COVERAGE_DIRECTORY" \
            -reporttypes:"MarkdownSummary;TextSummary" \
            -assemblyfilters:"${{ vars.COVERAGE_ASSEMBLY_FILTERS }}"

      - name: Add coverage to job summary
        if: always()
        run: |
          echo "## Coverage" >> $GITHUB_STEP_SUMMARY
          cat "$COVERAGE_DIRECTORY/Summary.md" >> $GITHUB_STEP_SUMMARY

      - name: Assert coverage threshold
        run: |
          LINE_COVERAGE=$(grep -Po 'Line coverage[:\s]+\K[\d.]+' "$COVERAGE_DIRECTORY/Summary.txt" | head -1 || echo 0)
          echo "ðŸ“Š Line coverage: ${LINE_COVERAGE}% (threshold: ${{ vars.COVERAGE_THRESHOLD }}%)"
          awk -v c="$LINE_COVERAGE" -v t="${{ vars.COVERAGE_THRESHOLD }}" 'BEGIN{exit (c+0<t+0)}' \
            || { echo "âŒ Coverage ${LINE_COVERAGE}% Ð½Ð¸Ð¶Ðµ Ð¿Ð¾Ñ€Ð¾Ð³Ð° ${{ vars.COVERAGE_THRESHOLD }}%"; exit 1; }
