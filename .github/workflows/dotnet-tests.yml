on:
  workflow_call:
    inputs:
      project_folder:
        type: string
        default: .
      coverage_assembly_filters:
        type: string
      coverage_threshold:
        type: string

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      REPORT_DIRECTORY: tests-report
      COVERAGE_DIRECTORY: tests-report/coverage
      COVERAGE_ASSEMBLY_FILTERS: ${{ inputs.coverage_assembly_filters }}
      COVERAGE_THRESHOLD: ${{ inputs.coverage_threshold }}

    steps:
      - uses: actions/checkout@v4

      - name: dotnet restore
        working-directory: ${{ inputs.project_folder }}
        run: |
          dotnet restore

      - name: Run tests with coverage
        working-directory: ${{ inputs.project_folder }}
        run: |
          set -eo pipefail
          mkdir -p "$REPORT_DIRECTORY"

          set +e
          dotnet test \
            --results-directory "$REPORT_DIRECTORY" \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=test_results.trx"
          TEST_EXIT=$?
          set -e

          echo "Test exit code saved: $TEST_EXIT"
          echo "TEST_EXIT=$TEST_EXIT" >> $GITHUB_ENV

      - name: Install report tools
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.4.16
          dotnet tool install --global trx2junit
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

          sudo apt-get update
          sudo apt-get install -y nodejs npm
          sudo npm i -g xunit-viewer

      - name: Convert trx â†’ junit
        run: |
          mkdir -p "$REPORT_DIRECTORY/junit"
          trx2junit "$REPORT_DIRECTORY/test_results.trx" --output "$REPORT_DIRECTORY/junit"

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"**/coverage.cobertura.xml" \
            -targetdir:"$COVERAGE_DIRECTORY" \
            -reporttypes:"Html;Cobertura;TextSummary" \
            -assemblyfilters:"$COVERAGE_ASSEMBLY_FILTERS"

          cat > "$REPORT_DIRECTORY/coverage-report.html" <<'HTML'
          <!DOCTYPE html>
          <html>
          <head>
              <meta http-equiv="refresh" content="0; url=coverage/index.html">
          </head>
          </html>
          HTML

      - name: Generate HTML test report
        run: |
          xunit-viewer -r $REPORT_DIRECTORY/junit -o $REPORT_DIRECTORY/tests-report.html -n "Tests Report"

      - name: Assert coverage threshold
        run: |
          LINE_COVERAGE=$(grep -Po 'Line coverage[:\s]+\K[\d.]+' "$COVERAGE_DIRECTORY/Summary.txt" | head -1 || echo 0)
          echo "ðŸ“Š Line coverage: ${LINE_COVERAGE}% (threshold: ${COVERAGE_THRESHOLD}%)"
          awk -v c="$LINE_COVERAGE" -v t="$COVERAGE_THRESHOLD" 'BEGIN{exit (c+0<t+0)}' \
            || { echo "âŒ Coverage ${LINE_COVERAGE}% Ð½Ð¸Ð¶Ðµ Ð¿Ð¾Ñ€Ð¾Ð³Ð° ${COVERAGE_THRESHOLD}%"; exit 1; }

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tests-and-coverage-report
          retention-days: 1
          path: |
            tests-report/coverage/
            tests-report/tests-report.html
            tests-report/coverage-report.html
