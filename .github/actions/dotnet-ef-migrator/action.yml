name: Dotnet EF Migrator
description: Build and run EF migrator docker image
inputs:
  registry-user:
    required: true
  registry-token:
    required: true
  env-file:
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: Create nuget.config
      if: ${{ vars.NUGET_CONFIG != '' }}
      shell: bash
      env:
        NUGET_CONFIG: ${{ vars.NUGET_CONFIG }}
        NUGET_PROVIDER: ${{ vars.NUGET_PROVIDER }}
        REGISTRY_USER: ${{ inputs.registry-user }}
        REGISTRY_TOKEN: ${{ inputs.registry-token }}
      run: |
        echo "$NUGET_CONFIG" | envsubst > ${{ vars.PROJECT_FOLDER }}/nuget.config

    - name: Create .env for migrator
      shell: bash
      run: |
        echo "${{ inputs.env-file }}" > "${{ vars.MIGRATOR_FOLDER }}/.env"

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          nuget-

    - name: Restore migrator
      shell: bash
      run: |
        dotnet restore "${{ vars.MIGRATOR_FOLDER }}/${{ vars.MIGRATOR_PROJECT }}"

    - name: Setup Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container

    - name: Build migrator image
      uses: docker/build-push-action@v6
      with:
        context: ${{ vars.PROJECT_FOLDER }}
        file: ${{ vars.PROJECT_FOLDER }}/${{ vars.MIGRATOR_FOLDER }}/Dockerfile
        push: false
        load: true
        tags: migrator-image
        build-args: |
          BUILD_CONFIGURATION=Release
         
        cache-from: type=gha,scope=${{ github.repository }}-migrator
        cache-to: type=gha,mode=max,scope=${{ github.repository }}-migrator

    - name: Run migrations
      shell: bash
      run: |
        docker run --rm --env-file "${{ vars.MIGRATOR_FOLDER }}/.env" migrator-image
