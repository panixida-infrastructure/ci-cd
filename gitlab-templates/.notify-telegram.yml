.notify_telegram:
  image: alpine/curl:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      set -euo pipefail

      # --- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø–∞–π–ø–ª–∞–π–Ω–∞ ---
      JOBS=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/pipelines/$CI_PIPELINE_ID/jobs")

      FAILED_JOBS=$(echo "$JOBS" | jq -r '.[] | select(.status == "failed") | .name' | paste -sd ', \n ' -)
      SUCCESSFUL_JOBS=$(echo "$JOBS" | jq -r '.[] | select(.status == "success") | .name' | paste -sd ', \n ' -)
      CANCELED_JOBS=$(echo "$JOBS" | jq -r '.[] | select(.status == "canceled") | .name' | paste -sd ', \n ' -)
      SKIPPED_JOBS=$(echo "$JOBS" | jq -r '.[] | select(.status == "skipped") | .name' | paste -sd ', \n ' -)

      DETAILS=""
      if [ -n "$SUCCESSFUL_JOBS" ]; then
        DETAILS="${DETAILS} \n ‚úÖ *–£—Å–ø–µ—à–Ω—ã–µ –∑–∞–¥–∞—á–∏:* \n ${SUCCESSFUL_JOBS} \n "
      fi
      if [ -n "$FAILED_JOBS" ]; then
        DETAILS="${DETAILS} \n ‚ùå *–ù–µ—É—Å–ø–µ—à–Ω—ã–µ –∑–∞–¥–∞—á–∏:* \n ${FAILED_JOBS} \n "
      fi
      if [ -n "$CANCELED_JOBS" ]; then
        DETAILS="${DETAILS} \n üö´ *–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:* \n ${CANCELED_JOBS} \n "
      fi
      if [ -n "$SKIPPED_JOBS" ]; then
        DETAILS="${DETAILS} \n ‚è≠Ô∏è *–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:* \n ${SKIPPED_JOBS} \n "
      fi

      # --- –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å ---
      if [ -z "$FAILED_JOBS" ] && [ -z "$CANCELED_JOBS" ]; then
        STATUS="‚úÖ –ü–∞–π–ø–ª–∞–π–Ω *${CI_PIPELINE_ID}* –∑–∞–≤–µ—Ä—à–∏–ª—Å—è *—É—Å–ø–µ—à–Ω–æ*."
      else
        STATUS="‚ùå –ü–∞–π–ø–ª–∞–π–Ω *${CI_PIPELINE_ID}* –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å *–æ—à–∏–±–∫–∞–º–∏*."
      fi

      # --- –î–æ—Å—Ç–∞—ë–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ MR ---
      MR_IID="${CI_MERGE_REQUEST_IID:-}"
      MR_INFO=""
      if [ -n "$MR_IID" ]; then
        # MR pipeline
        MR_INFO=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$MR_IID")
      else
        # post-merge / –æ–±—ã—á–Ω—ã–π pipeline ‚Äî –∏—â–µ–º MR –ø–æ –∫–æ–º–º–∏—Ç—É
        MR_FROM_COMMIT=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/commits/$CI_COMMIT_SHA/merge_requests")
        MR_IID=$(echo "$MR_FROM_COMMIT" | jq -r '.[0].iid // empty')
        if [ -n "$MR_IID" ]; then
          MR_INFO=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
            "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$MR_IID")
        fi
      fi

      MR_AUTHOR=""
      MR_MERGED_BY=""
      MR_TITLE=""
      MR_URL=""
      if [ -n "$MR_INFO" ]; then
        MR_AUTHOR=$(echo "$MR_INFO" | jq -r '.author.name // empty')
        MR_MERGED_BY=$(echo "$MR_INFO" | jq -r '.merged_by.name // empty')
        MR_TITLE=$(echo "$MR_INFO" | jq -r '.title // empty')
        MR_URL=$(echo "$MR_INFO" | jq -r '.web_url // empty')
      fi

      # --- –§–æ—Ä–º–∏—Ä—É–µ–º –±–ª–æ–∫ –∞–≤—Ç–æ—Ä–∞/–º–µ—Ä–¥–∂–µ—Ä–∞ ---
      AUTHOR_BLOCK=""
      if [ -n "$MR_AUTHOR" ]; then
        AUTHOR_BLOCK="${AUTHOR_BLOCK}\n- –ê–≤—Ç–æ—Ä MR: *${MR_AUTHOR}*"
      fi
      if [ -n "$MR_MERGED_BY" ]; then
        AUTHOR_BLOCK="${AUTHOR_BLOCK}\n- –ó–∞–º–µ—Ä–∂–∏–ª: *${MR_MERGED_BY}*"
      fi
      if [ -z "$AUTHOR_BLOCK" ]; then
        # –ù–µ—Ç MR (–∏–ª–∏ –Ω–µ –Ω–∞—à–ª–∏) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞
        AUTHOR_BLOCK="\n- –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: *${GITLAB_USER_NAME}*"
      fi

      # --- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°—Å—ã–ª–∫–∞ –Ω–∞ MR, –µ—Å–ª–∏ –Ω–∞—à–ª–∏ ---
      MR_LINE=""
      if [ -n "$MR_URL" ] && [ -n "$MR_TITLE" ]; then
        MR_LINE="\n- MR: [${MR_TITLE}](${MR_URL})"
      fi

      # --- –ü–æ–ª—É—á–∞–µ–º URL –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ GitLab API ---
      ENV_URL=""
      if [ -n "$DEPLOY_ENV" ]; then
        ENVIRONMENTS_JSON=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
            "$CI_API_V4_URL/projects/$CI_PROJECT_ID/environments")

        ENV_URL=$(echo "$ENVIRONMENTS_JSON" | jq -r --arg NAME "$DEPLOY_ENV" '.[] | select(.name == $NAME) | .external_url // empty')
        fi

      if [ -n "$ENV_URL" ]; then
        ENV_LINE="\n- URL: [${ENV_URL}](${ENV_URL})"
      else
        ENV_LINE="\n- URL: (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)"
      fi

      # --- –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç ---
      TEXT="$STATUS \n${DETAILS} üìù *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ:* \n- –ü—Ä–æ–µ–∫—Ç: *${CI_PROJECT_NAME}* \n- –í–µ—Ç–∫–∞: *${CI_COMMIT_REF_NAME}*${AUTHOR_BLOCK}${MR_LINE}${ENV_LINE}"

      # --- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram ---
      curl -s --header 'Content-Type: application/json' \
        --request 'POST' \
        --data "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
        "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" 
  when: always
  allow_failure: true
  dependencies: []
